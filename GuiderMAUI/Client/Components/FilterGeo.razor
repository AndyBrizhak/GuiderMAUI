@using Microsoft.Maui.Devices.Sensors
@using Microsoft.Maui.ApplicationModel

<div class="geo-wrapper">
    <button type="button"
            class="geo-btn @(IsActive ? "active" : "")"
            @onclick="ToggleGeoLocation"
            disabled="@isLoading">

        @if (isLoading)
        {
            @* Спиннер загрузки *@
            <span class="spinner"></span>
            <span>Locating...</span>
        }
        else
        {
            @* Иконка *@
            <span class="icon">📍</span>
            @* Если активно - пишем 10km, иначе просто Near Me *@
            <span>@(IsActive ? "Near Me (10km)" : "Near Me")</span>
        }
    </button>

    @* Вывод ошибки (красным текстом под кнопкой) *@
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <span class="error-msg">@errorMessage</span>
    }
</div>

@code {
    // Входящие параметры (чтобы кнопка знала, включена она или нет)
    [Parameter] public double? Latitude { get; set; }
    [Parameter] public double? Longitude { get; set; }

    // Событие: возвращает (Широта, Долгота, Радиус)
    [Parameter] public EventCallback<(double? lat, double? lon, double? dist)> OnGeoChanged { get; set; }

    private bool IsActive => Latitude.HasValue && Longitude.HasValue;
    private bool isLoading = false;
    private string? errorMessage;

    // Фиксированная дистанция 10 км (как мы договорились)
    private const double FIXED_DISTANCE_KM = 10;

    private async Task ToggleGeoLocation()
    {
        errorMessage = null;

        // 1. Если уже включено -> выключаем (сбрасываем)
        if (IsActive)
        {
            await OnGeoChanged.InvokeAsync((null, null, null));
            return;
        }

        // 2. Если выключено -> пытаемся найти координаты
        isLoading = true;
        try
        {
            // Проверяем, есть ли разрешение на использование GPS
            var status = await Permissions.CheckStatusAsync<Permissions.LocationWhenInUse>();

            // Если разрешения нет - запрашиваем у пользователя
            if (status != PermissionStatus.Granted)
            {
                status = await Permissions.RequestAsync<Permissions.LocationWhenInUse>();

                // Если пользователь отказал
                if (status != PermissionStatus.Granted)
                {
                    errorMessage = "Permission denied";
                    return;
                }
            }

            // Запрашиваем координаты (ждем до 10 секунд)
            var request = new GeolocationRequest(GeolocationAccuracy.Medium, TimeSpan.FromSeconds(10));
            var location = await Geolocation.Default.GetLocationAsync(request);

            if (location != null)
            {
                // Успех! Отправляем координаты родителю
                await OnGeoChanged.InvokeAsync((location.Latitude, location.Longitude, FIXED_DISTANCE_KM));
            }
            else
            {
                errorMessage = "Location not found";
            }
        }
        catch (Exception ex)
        {
            // Ошибка (например, GPS выключен в настройках телефона)
            Console.WriteLine($"Geo Error: {ex.Message}");
            errorMessage = "GPS Error";
        }
        finally
        {
            isLoading = false;
        }
    }
}