@using GuiderMAUI.Shared.Models
@inject NavigationManager Navigation

<div class="filter-card">
    @*  Текстовый поиск *@
    <FilterTextSearch InitialValue="@CurrentFilters.Q"
                      OnSearch="HandleTextSearch" />

    @*  Строка быстрых фильтров *@
    <div class="quick-filters-row">

        @* Кнопка Гео *@
        <FilterGeo Latitude="@CurrentFilters.Latitude"
                   Longitude="@CurrentFilters.Longitude"
                   OnGeoChanged="HandleGeoChange" />

        @* Переключатель Open Now *@
        <FilterStatus IsOpen="@CurrentFilters.IsOpen"
                      OnStatusChanged="HandleStatusChange" />
    </div>
</div>

@code {
    [Parameter] public PlaceFilterParams CurrentFilters { get; set; } = new();

    //  Обработчик ТЕКСТА ---
    private void HandleTextSearch(string? q)
    {
        // Передаем новый текст, остальные параметры берем из текущих
        Navigate(q, CurrentFilters.IsOpen, CurrentFilters.Latitude, CurrentFilters.Longitude, CurrentFilters.Distance);
    }

    //  Обработчик СТАТУСА (Open Now) ---
    private void HandleStatusChange(bool? isOpen)
    {
        // Передаем новый статус, остальное сохраняем
        Navigate(CurrentFilters.Q, isOpen, CurrentFilters.Latitude, CurrentFilters.Longitude, CurrentFilters.Distance);
    }

    //  Обработчик ГЕО  ---
    private void HandleGeoChange((double? lat, double? lon, double? dist) geo)
    {
        // Передаем новые координаты
        Navigate(CurrentFilters.Q, CurrentFilters.IsOpen, geo.lat, geo.lon, geo.dist);
    }

    // --- ГЛАВНЫЙ МЕТОД НАВИГАЦИИ  ---
    private void Navigate(string? q, bool? isOpen, double? lat, double? lon, double? dist)
    {
        var p = new Dictionary<string, object?>();

        //  Поиск (Если пустой - явно null)
        if (!string.IsNullOrWhiteSpace(q)) p["Q"] = q;
        else p["Q"] = null;

        //  Статус (ИСПРАВЛЕНИЕ БАГА: Явный null удаляет параметр из URL)
        if (isOpen == true) p["isOpen"] = "true";
        else p["isOpen"] = null;

        //  Гео-локация (Важно использовать InvariantCulture, чтобы были точки, а не запятые)
        if (lat.HasValue) p["latitude"] = lat.Value.ToString(System.Globalization.CultureInfo.InvariantCulture);
        else p["latitude"] = null;

        if (lon.HasValue) p["longitude"] = lon.Value.ToString(System.Globalization.CultureInfo.InvariantCulture);
        else p["longitude"] = null;

        if (dist.HasValue) p["distance"] = dist.Value;
        else p["distance"] = null;

        //  Сохраняем старые фильтры (Категория, Город, Провинция)
        if (!string.IsNullOrEmpty(CurrentFilters.Category)) p["Category"] = CurrentFilters.Category;
        if (!string.IsNullOrEmpty(CurrentFilters.Province)) p["Province"] = CurrentFilters.Province;
        if (!string.IsNullOrEmpty(CurrentFilters.City)) p["City"] = CurrentFilters.City;

        //  Сброс страницы
        p["Page"] = 1;
        if (CurrentFilters.PerPage > 0) p["PerPage"] = CurrentFilters.PerPage;

        // Генерируем URL
        var uri = Navigation.GetUriWithQueryParameters(p);
        Navigation.NavigateTo(uri);
    }
}