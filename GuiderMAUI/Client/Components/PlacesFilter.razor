@using GuiderMAUI.Shared.Models
@inject NavigationManager Navigation

<div class="filter-card">
    @* 1. Поиск *@
    <FilterTextSearch InitialValue="@CurrentFilters.Q" 
                      OnSearch="HandleTextSearch" />

    @* 3. Быстрые фильтры (Гео + Статус) *@
    <div class="quick-filters-row">
        <FilterGeo Latitude="@CurrentFilters.Latitude"
                   Longitude="@CurrentFilters.Longitude"
                   OnGeoChanged="HandleGeoChange" />

        <FilterStatus IsOpen="@CurrentFilters.IsOpen" 
                      OnStatusChanged="HandleStatusChange" />
    </div>

    @* 2. КАТЕГОРИИ  *@
    <FilterCategories SelectedCategory="@CurrentFilters.Category"
                      OnCategoryChanged="HandleCategoryChange" />

</div>

@code {
    [Parameter] public PlaceFilterParams CurrentFilters { get; set; } = new();

    // --- Обработчики ---

    private void HandleTextSearch(string? q) => 
        Navigate(q, CurrentFilters.Category, CurrentFilters.IsOpen, CurrentFilters.Latitude, CurrentFilters.Longitude, CurrentFilters.Distance);

    // НОВОЕ: Обработчик смены категории
    private void HandleCategoryChange(string? newCategory) =>
        Navigate(CurrentFilters.Q, newCategory, CurrentFilters.IsOpen, CurrentFilters.Latitude, CurrentFilters.Longitude, CurrentFilters.Distance);

    private void HandleStatusChange(bool? isOpen) => 
        Navigate(CurrentFilters.Q, CurrentFilters.Category, isOpen, CurrentFilters.Latitude, CurrentFilters.Longitude, CurrentFilters.Distance);

    private void HandleGeoChange((double? lat, double? lon, double? dist) geo) => 
        Navigate(CurrentFilters.Q, CurrentFilters.Category, CurrentFilters.IsOpen, geo.lat, geo.lon, geo.dist);


    // --- Главный метод Навигации (Обновлен) ---
    private void Navigate(string? q, string? category, bool? isOpen, double? lat, double? lon, double? dist)
    {
        var p = new Dictionary<string, object?>();

        // 1. Поиск
        if (!string.IsNullOrWhiteSpace(q)) p["Q"] = q;
        else p["Q"] = null;

        // 2. Категория (НОВОЕ)
        if (!string.IsNullOrEmpty(category)) p["Category"] = category;
        else p["Category"] = null;

        // 3. Статус
        if (isOpen == true) p["isOpen"] = "true";
        else p["isOpen"] = null;

        // 4. Гео (с точкой вместо запятой)
        if (lat.HasValue) p["latitude"] = lat.Value.ToString(System.Globalization.CultureInfo.InvariantCulture);
        else p["latitude"] = null;

        if (lon.HasValue) p["longitude"] = lon.Value.ToString(System.Globalization.CultureInfo.InvariantCulture);
        else p["longitude"] = null;

        if (dist.HasValue) p["distance"] = dist.Value.ToString(System.Globalization.CultureInfo.InvariantCulture);
        else p["distance"] = null;

        // 5. Остальные поля (пока берем старые)
        if (!string.IsNullOrEmpty(CurrentFilters.Province)) p["Province"] = CurrentFilters.Province;
        if (!string.IsNullOrEmpty(CurrentFilters.City)) p["City"] = CurrentFilters.City;

        // 6. Сброс страницы
        p["Page"] = 1;
        if (CurrentFilters.PerPage > 0) p["PerPage"] = CurrentFilters.PerPage;

        Navigation.NavigateTo(Navigation.GetUriWithQueryParameters(p));
    }
}