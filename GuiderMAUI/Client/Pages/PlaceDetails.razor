@page "/place/{url}"
@using GuiderMAUI.Shared.Models
@using GuiderMAUI.Shared.Services
@using System.Globalization
@using GuiderMAUI.Client.Components.PlaceDetailsComponents

@inject IPlacesService PlacesService
@inject NavigationManager Navigation

<div class="details-root">

    @if (isLoading)
    {
        <div class="state-center">
            <div class="spinner"></div>
            <p>Loading...</p>
        </div>
    }
    else if (place == null)
    {
        <div class="state-center">
            <h3>Place not found</h3>
            <button class="mini-map-btn" style="width: auto; padding: 10px 20px;" @onclick='() => Navigation.NavigateTo("/")'>
                Back to Home
            </button>
        </div>
    }
    else
    {
        
        <PlaceHeader Title="@place.Name" OnBackClick='() => Navigation.NavigateTo("/")' />

        <div class="content-scroll-area">

            <PlaceGallery Images="@place.ImgLink" Name="@place.Name" />
            <div class="content-section">
                @if (!string.IsNullOrEmpty(place.Category))
                {
                    <span class="category-text">@place.Category</span>
                }

                <h1 class="place-title">@place.Name</h1>

                <div class="address-map-line">
                    @if (place.Address != null)
                    {
                        <div class="address-text">
                            @string.Join(", ", new[] { place.Address.City, place.Address.Province }.Where(s => !string.IsNullOrEmpty(s)))
                        </div>
                    }

                    @if (IsLocationValid(place.Location))
                    {
                        <a href="@GetGoogleMapsUrl(place.Location)" target="_blank" class="mini-map-btn" title="Open in Maps">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                <circle cx="12" cy="10" r="3"></circle>
                            </svg>
                        </a>
                    }
                </div>
            </div>

            @if (!string.IsNullOrEmpty(place.Description))
            {
                <div class="content-section description-section">
                    <div class="description-text">
                        @((MarkupString)place.Description)
                    </div>
                </div>
            }

            @if (place.Schedule != null && place.Schedule.Any())
            {
                <div class="content-section">
                    <details class="schedule-details">
                        <summary>
                            <span>Working Hours</span>
                            <span style="font-size: 0.8em; color: #999;">▼</span>
                        </summary>
                        <div class="schedule-table">
                            @foreach (var entry in place.Schedule)
                            {
                                <div class="schedule-block">
                                    <div class="schedule-days">
                                        @FormatDays(entry.Days)
                                    </div>
                                    <div class="schedule-hours">
                                        @if (entry.Hours != null && entry.Hours.Any())
                                        {
                                            @foreach (var hour in entry.Hours)
                                            {
                                                <span>@hour.Start - @hour.End</span>
                                            }
                                        }
                                        else
                                        {
                                            <span class="closed-text">Closed</span>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </details>
                </div>
            }

            @if (HasContacts(place))
            {
                <div class="content-section">
                    <h3 class="section-subtitle">Contacts</h3>
                    <div class="social-links">

                        @if (place.Phone != null && !string.IsNullOrEmpty(place.Phone.Callable))
                        {
                            <a href="tel:@place.Phone.Callable" class="social-chip phone">
                                📞 Call
                            </a>
                        }

                        @if (place.Phone != null && !string.IsNullOrEmpty(place.Phone.Whatsapp))
                        {
                            <a href="https://wa.me/@(place.Phone.Whatsapp.Replace("+", "").Replace(" ", ""))" target="_blank" class="social-chip whatsapp">
                                💬 WhatsApp
                            </a>
                        }

                        @if (place.SocialNetwork != null && !string.IsNullOrEmpty(place.SocialNetwork.Instagram))
                        {
                            <a href="@place.SocialNetwork.Instagram" target="_blank" class="social-chip instagram">Instagram</a>
                        }

                        @if (place.SocialNetwork != null && !string.IsNullOrEmpty(place.SocialNetwork.Facebook))
                        {
                            <a href="@place.SocialNetwork.Facebook" target="_blank" class="social-chip facebook">Facebook</a>
                        }
                    </div>
                </div>
            }

            @if (place.Tags != null && place.Tags.Any())
            {
                <div class="content-section" style="border-bottom: none;">
                    <div class="tags-wrapper">
                        @foreach (var tag in place.Tags)
                        {
                            <span class="tag-chip">#@tag</span>
                        }
                    </div>
                </div>
            }
        </div>
    }

</div>

@code {
    [Parameter]
    public string Url { get; set; } = "";

    private Place? place;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            isLoading = true;
            if (!string.IsNullOrEmpty(Url))
            {
                place = await PlacesService.GetPlaceByUrlAsync(Url);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private bool IsLocationValid(Location? loc)
    {
        return loc != null && loc.Coordinates != null && loc.Coordinates.Count >= 2;
    }

    private string GetGoogleMapsUrl(Location loc)
    {
        if (!IsLocationValid(loc)) return "#";
        var lon = loc.Coordinates[0].ToString(CultureInfo.InvariantCulture);
        var lat = loc.Coordinates[1].ToString(CultureInfo.InvariantCulture);
        return $"https://www.google.com/maps/search/?api=1&query={lat},{lon}";
    }

    private string FormatDays(List<string> days)
    {
        if (days == null || !days.Any()) return "";
        var shortDays = days.Select(d => d.Length > 3 ? d.Substring(0, 3) : d);
        return string.Join(", ", shortDays);
    }

    private bool HasContacts(Place p)
    {
        bool hasPhone = p.Phone != null && (!string.IsNullOrEmpty(p.Phone.Callable) || !string.IsNullOrEmpty(p.Phone.Whatsapp));
        bool hasSocial = p.SocialNetwork != null && (!string.IsNullOrEmpty(p.SocialNetwork.Instagram) || !string.IsNullOrEmpty(p.SocialNetwork.Facebook));
        return hasPhone || hasSocial;
    }
}